<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .choice-btn {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            text-align: left;
            background: white;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            cursor: pointer;
            color: #1e293b;
        }
        .choice-btn:hover { border-color: #0052CC; background-color: #f8faff; }
        .choice-btn i { color: #cbd5e1; font-size: 0.9rem; transition: color 0.2s ease; }
        .choice-btn:hover i { color: #0052CC; }

        .checkbox-card {
            display: flex;
            align-items: center;
            padding: 0.85rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
            color: #1e293b;
        }
        .checkbox-card:hover { border-color: #0052CC; }
        input[type="checkbox"] { width: 1.1rem; height: 1.1rem; accent-color: #0052CC; margin-right: 1rem; cursor: pointer; }
        
        .error-text { color: #ef4444; font-size: 0.75rem; margin-top: 0.25rem; display: none; }
        .input-error { border-color: #ef4444 !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4 text-sm">

    <div class="bg-white rounded-[2rem] shadow-xl w-full max-w-lg overflow-hidden border border-gray-100 font-sans">
        
        <div class="bg-[#0052CC] p-8 text-white">
            <div class="flex justify-between items-center mb-4">
                <span class="text-[10px] bg-white/20 px-2 py-1 rounded uppercase tracking-widest font-bold">SIMULATEUR MAPRIMEADAPT'</span>
                <span id="stepCounter" class="text-xs opacity-70">Question 1 / 8</span>
            </div>
            <div id="headerContent">
                <h1 class="text-xl font-bold leading-tight">Découvrez votre éligibilité et le montant de votre aide en 2 minutes</h1>
            </div>
            <div class="w-full bg-blue-900/40 h-1.5 rounded-full mt-6">
                <div id="progressBar" class="bg-green-400 h-full rounded-full transition-all duration-700" style="width: 12.5%"></div>
            </div>
        </div>

        <div class="p-8 min-h-[480px] flex flex-col justify-between">
            <div id="questions">

                <div class="step active" id="step1">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 leading-snug">Quel âge avez-vous ?</h2>
                    <div class="choice-btn" onclick="saveData('age', '70+')"><span>70 ans ou plus</span><i class="fa-solid fa-chevron-right"></i></div>
                    <div class="choice-btn" onclick="saveData('age', '60-69')"><span>Entre 60 et 69 ans</span><i class="fa-solid fa-chevron-right"></i></div>
                    <div class="choice-btn" onclick="saveData('age', '60-')"><span>60 ans ou moins</span><i class="fa-solid fa-chevron-right"></i></div>
                </div>

                <div class="step" id="step2">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">Vous êtes ?</h2>
                    <div class="choice-btn" onclick="saveData('statut', 'Propriétaire occupant')"><span>Propriétaire occupant</span><i class="fa-solid fa-house"></i></div>
                    <div class="choice-btn" onclick="saveData('statut', 'Propriétaire bailleur')"><span>Propriétaire bailleur</span><i class="fa-solid fa-key"></i></div>
                    <div class="choice-btn" onclick="saveData('statut', 'Locataire privé')"><span>Locataire d'un logement privé</span><i class="fa-solid fa-building"></i></div>
                    <div class="choice-btn" onclick="saveData('statut', 'Locataire social')"><span>Locataire d'un logement social</span><i class="fa-solid fa-city"></i></div>
                </div>

                <div class="step" id="step3">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 leading-snug">Quel est le code postal du logement ?</h2>
                    <input type="text" id="cp" maxlength="5" placeholder="Ex: 69001" oninput="this.value = this.value.replace(/[^0-9]/g, '')" 
                           class="w-full p-4 border border-gray-200 rounded-xl outline-none focus:border-blue-600 text-xl font-medium text-slate-700 mb-1 transition-all">
                    <p id="error-cp" class="error-text">Veuillez entrer un code postal valide à 5 chiffres.</p>
                    <button onclick="validerCP()" class="w-full bg-[#0052CC] text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all uppercase tracking-wider text-sm mt-4">Continuer</button>
                </div>

                <div class="step" id="step4">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 leading-snug">Combien de personnes composent votre foyer ?</h2>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="choice-btn justify-center p-5 font-bold" onclick="saveData('foyer', 1)">1</div>
                        <div class="choice-btn justify-center p-5 font-bold" onclick="saveData('foyer', 2)">2</div>
                        <div class="choice-btn justify-center p-5 font-bold" onclick="saveData('foyer', 3)">3</div>
                        <div class="choice-btn justify-center p-5 font-bold" onclick="saveData('foyer', 4)">4</div>
                        <div class="choice-btn justify-center p-5 font-bold" onclick="saveData('foyer', 5)">5</div>
                        <div class="choice-btn justify-center p-5 font-bold" onclick="saveData('foyer', 6)">6+</div>
                    </div>
                </div>

                <div class="step" id="step5">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">Quel est le revenu fiscal de référence de votre foyer ?</h2>
                    <div id="dynamicIncomes"></div>
                </div>

                <div class="step" id="step6">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 leading-snug">Quels sont les aménagements souhaités ?</h2>
                    <div id="travauxForm">
                        <label class="checkbox-card"><input type="checkbox" name="work" value="Douche"><span class="font-bold">Douche de plain-pied</span></label>
                        <label class="checkbox-card"><input type="checkbox" name="work" value="Monte-escalier"><span class="font-bold">Monte-escalier</span></label>
                        <label class="checkbox-card"><input type="checkbox" name="work" value="Barres"><span class="font-bold">Barres d'appui</span></label>
                        <label class="checkbox-card"><input type="checkbox" name="work" value="Rampes"><span class="font-bold">Rampes d'accès</span></label>
                        <label class="checkbox-card"><input type="checkbox" name="work" value="A définir"><span class="font-bold">À définir</span></label>
                        <button onclick="nextStep()" class="w-full bg-[#0052CC] text-white py-4 rounded-xl font-bold mt-4 shadow-md uppercase tracking-wider text-sm">Continuer</button>
                    </div>
                </div>

                <div class="step" id="step7">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">Êtes-vous en situation de handicap ?</h2>
                    <div class="choice-btn" onclick="saveData('handicap', 'Oui')"><span>Oui (taux ≥ 50% ou PCH)</span><i class="fa-solid fa-check"></i></div>
                    <div class="choice-btn" onclick="saveData('handicap', 'Non')"><span>Non</span><i class="fa-solid fa-xmark"></i></div>
                    <div class="choice-btn" onclick="saveData('handicap', 'NSP')"><span>Je ne sais pas</span><i class="fa-solid fa-question"></i></div>
                </div>

                <div class="step" id="step8">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 leading-snug">À quel moment souhaitez-vous débuter les travaux ?</h2>
                    <div class="choice-btn" onclick="saveData('urgence', 'ASAP')"><span>Le plus tôt possible (Urgent)</span><i class="fa-solid fa-bolt"></i></div>
                    <div class="choice-btn" onclick="saveData('urgence', '3-6 mois')"><span>D'ici 3 à 6 mois</span><i class="fa-solid fa-calendar"></i></div>
                    <div class="choice-btn" onclick="saveData('urgence', 'Année pro')"><span>C'est pour l'année prochaine</span><i class="fa-solid fa-clock"></i></div>
                    <div class="choice-btn text-slate-400" onclick="saveData('urgence', 'Info')"><span>Je souhaite simplement me renseigner</span><i class="fa-solid fa-info"></i></div>
                </div>

                <div class="step" id="stepFinal">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-check text-lg"></i></div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2 leading-snug">Votre résultat est prêt ! ✅</h2>
                        <p class="text-slate-500 text-sm px-4 leading-relaxed font-medium">Laissez-nous vos coordonnées pour recevoir votre estimation personnalisée.</p>
                    </div>
                    <div class="space-y-4">
                        <input type="text" id="lead_nom" placeholder="Prénom & Nom" class="w-full p-4 bg-slate-50 border border-gray-200 rounded-xl outline-none font-medium text-slate-700">
                        <input type="email" id="lead_email" placeholder="Email" class="w-full p-4 bg-slate-50 border border-gray-200 rounded-xl outline-none font-medium text-slate-700">
                        <input type="tel" id="lead_tel" maxlength="10" placeholder="Numéro de téléphone" class="w-full p-4 bg-slate-50 border border-gray-200 rounded-xl outline-none font-medium text-slate-700">
                        
                        <div class="mt-4">
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" id="consentement" class="mt-1">
                                <span class="text-[11px] text-gray-500 leading-tight">
                                    J'accepte que mes données soient utilisées et transmises à mes partenaires commerciaux dans le cadre de la mise en relation pour des services liés à l'adaptation du logement.
                                </span>
                            </label>
                            <p id="err-consent" class="error-text">Vous devez accepter les conditions pour continuer.</p>
                        </div>

                        <button onclick="finalSubmit()" class="w-full bg-[#FF6B00] hover:bg-[#E66000] text-white py-5 rounded-2xl font-bold text-lg shadow-lg transition-all uppercase tracking-wide">Voir mon éligibilité</button>
                    </div>
                </div>

                <div class="step" id="stepResult">
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 text-green-600 rounded-full mb-6"><i class="fa-solid fa-sack-dollar text-3xl"></i></div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Estimation Terminée</h2>
                        <div class="bg-blue-50 border-2 border-blue-600 rounded-3xl p-8 mb-8 mt-6">
                            <span id="montantAide" class="text-5xl font-black text-blue-600 leading-none">0 €</span>
                        </div>
                        <p class="text-xs text-slate-600 italic px-6">Un conseiller vous contactera prochainement.</p>
                    </div>
                </div>
            </div>
            <button id="backBtn" onclick="prevStep()" class="mt-8 text-[10px] font-bold text-gray-400 uppercase tracking-widest hidden hover:text-blue-600 transition-colors"><i class="fa-solid fa-arrow-left mr-2"></i>Retour</button>
        </div>
    </div>

    <script>
        // Initialisation EmailJS
        (function(){ emailjs.init("JS4O3kRt63JPjwHYO"); })();

        let currentStep = 1;
        let responses = { pourcentage: 0 };
        const idfZones = ["75", "77", "78", "91", "92", "93", "94", "95"];
        const PLAFOND_TRAVAUX = 22000;

        const baremesIDF = { 1: { tm: 23768, m: 28933 }, 2: { tm: 34884, m: 42463 }, 3: { tm: 41893, m: 51000 }, 4: { tm: 48914, m: 59549 }, 5: { tm: 55961, m: 68123 }, plus: { tm: 7038, m: 8568 } };
        const baremesProvince = { 1: { tm: 17173, m: 22015 }, 2: { tm: 25115, m: 32197 }, 3: { tm: 30206, m: 38719 }, 4: { tm: 35285, m: 45234 }, 5: { tm: 40388, m: 51775 }, plus: { tm: 5094, m: 6525 } };

        function saveData(key, val, p = null) {
            responses[key] = val;
            if(p !== null) responses.pourcentage = p;
            if(key === 'foyer') generateIncomes();
            nextStep();
        }

        function validerCP() {
            const input = document.getElementById('cp');
            if(input.value.length !== 5) { input.classList.add('input-error'); return; }
            input.classList.remove('input-error');
            responses.cp = input.value;
            responses.isIdf = idfZones.includes(input.value.substring(0, 2));
            nextStep();
        }

        function generateIncomes() {
            const zone = responses.isIdf ? baremesIDF : baremesProvince;
            const nb = responses.foyer;
            let tm, m;
            if (nb <= 5) { tm = zone[nb].tm; m = zone[nb].m; } 
            else { const extra = nb - 5; tm = zone[5].tm + (zone.plus.tm * extra); m = zone[5].m + (zone.plus.m * extra); }
            document.getElementById('dynamicIncomes').innerHTML = `
                <div class="choice-btn" onclick="saveData('revenu', 'Très Modeste', 70)"><span>Moins de ${tm.toLocaleString()} €</span><i class="fa-solid fa-chevron-right"></i></div>
                <div class="choice-btn" onclick="saveData('revenu', 'Modeste', 50)"><span>Entre ${tm.toLocaleString()} € et ${m.toLocaleString()} €</span><i class="fa-solid fa-chevron-right"></i></div>
                <div class="choice-btn" onclick="saveData('revenu', 'Supérieur', 0)"><span>Plus de ${m.toLocaleString()} €</span><i class="fa-solid fa-chevron-right"></i></div>`;
        }

        function nextStep() { currentStep++; updateUI(); }
        function prevStep() { if(currentStep > 1) { currentStep--; updateUI(); } }

        function finalSubmit() {
            const nom = document.getElementById('lead_nom');
            const email = document.getElementById('lead_email');
            const tel = document.getElementById('lead_tel');
            const consent = document.getElementById('consentement');
            let hasError = false;

            if(nom.value.length < 2) { nom.classList.add('input-error'); hasError = true; } else { nom.classList.remove('input-error'); }
            if(!email.value.includes('@')) { email.classList.add('input-error'); hasError = true; } else { email.classList.remove('input-error'); }
            if(tel.value.length < 10) { tel.classList.add('input-error'); hasError = true; } else { tel.classList.remove('input-error'); }
            if(!consent.checked) { document.getElementById('err-consent').style.display = 'block'; hasError = true; } else { document.getElementById('err-consent').style.display = 'none'; }

            if(hasError) return;

            const montant = (PLAFOND_TRAVAUX * responses.pourcentage) / 100;
            const montantTexte = montant.toLocaleString() + " €";
            const travaux = Array.from(document.querySelectorAll('input[name="work"]:checked')).map(el => el.value).join(', ');

            // Préparation des données complètes
            const params = {
                name: nom.value,
                email: email.value,
                tel: tel.value,
                age: responses.age,
                statut: responses.statut,
                cp: responses.cp,
                foyer: responses.foyer,
                revenus: responses.revenu,
                travaux: travaux,
                handicap: responses.handicap,
                urgence: responses.urgence,
                aide: montantTexte
            };

            // 1. Envoi vers Google Sheet (Méthode Directe)
            fetch("https://script.google.com/macros/s/AKfycbwwfnRjFgphSFc0bOyoyWTVkF_OvBSL2kZiBT90v4J6BMe2e8y6QSeV75j_dqUYCTTr/exec", {
                method: "POST",
                mode: "no-cors", // Nécessaire pour Apps Script
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(params)
            });

            // 2. Envoi vers EmailJS
            emailjs.send("service_5fff439", "template_dcj11iv", params)
                .then(() => {
                    document.getElementById('montantAide').innerText = montantTexte;
                    currentStep = 10; 
                    updateUI();
                }, (err) => {
                    alert("Erreur lors de l'envoi. Veuillez réessayer.");
                    console.error(err);
                });
        }

        function updateUI() {
            const steps = document.querySelectorAll('.step');
            steps.forEach((s, i) => { const stepNum = (i === 9) ? 10 : i + 1; s.classList.toggle('active', stepNum === currentStep); });
            if(currentStep === 10) { document.getElementById('headerContent').classList.add('hidden'); document.getElementById('stepCounter').innerText = "Résultat"; document.getElementById('progressBar').style.width = '100%'; document.getElementById('backBtn').classList.add('hidden'); } 
            else { document.getElementById('headerContent').classList.remove('hidden'); document.getElementById('progressBar').style.width = (Math.min(currentStep, 9) / 9 * 100) + '%'; document.getElementById('stepCounter').innerText = currentStep <= 8 ? `Question ${currentStep} / 8` : "Dernière étape"; document.getElementById('backBtn').classList.toggle('hidden', currentStep === 1); }
        }
    </script>
</body>
</html>
